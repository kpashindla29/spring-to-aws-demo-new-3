name: CI Pipeline (Jenkins-like)

# Add required permissions
permissions:
  contents: read
  pull-requests: write
  actions: read
  checks: write

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: Compile
      run: |
        echo 'compiling..'
        mvn compile
      continue-on-error: false
    
    - name: Code Review (PMD)
      id: pmd
      run: |
        echo 'codereview..'
        mvn -P metrics pmd:pmd
      continue-on-error: true
    
    - name: Publish PMD Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pmd-results
        path: '**/target/pmd.xml'
    
    - name: Comment PMD Results on PR
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const glob = require('glob');
          
          // Find PMD results
          const files = glob.sync('**/target/pmd.xml');
          
          if (files.length === 0) {
            console.log('No PMD results found');
            return;
          }
          
          // Read and parse PMD results (simplified - you can enhance this)
          const pmdContent = fs.readFileSync(files[0], 'utf8');
          const violationCount = (pmdContent.match(/<violation/g) || []).length;
          
          let comment = '## ðŸ” PMD Code Review Results\n\n';
          
          if (violationCount > 0) {
            comment += `âš ï¸ Found **${violationCount}** potential issues.\n\n`;
            comment += 'Download the PMD artifacts for details.';
          } else {
            comment += 'âœ… No PMD violations found!';
          }
          
          // Add to summary for better visibility
          comment += '\n\n---\n*Powered by PMD analysis*';
          
          // Find and update or create comment
          const { data: comments } = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('PMD Code Review Results')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              comment_id: botComment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }
    
    - name: Run Tests with Clover
      run: |
        echo 'running tests with clover..'
        mvn test clover:aggregate clover:clover
      continue-on-error: false
    
    - name: Upload Clover Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: clover-reports
        path: |
          target/site/clover/**
          target/site/clover.xml
    
    - name: Clover Coverage Report
      id: clover
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          const xml2js = require('xml2js');  // Better XML parsing
          
          const thresholds = {
            method: 70,
            conditional: 80,
            statement: 80
          };
          
          const cloverPath = 'target/site/clover.xml';
          let coverage = {
            method: 0,
            conditional: 0,
            statement: 0,
            passed: false
          };
          
          if (fs.existsSync(cloverPath)) {
            const content = fs.readFileSync(cloverPath, 'utf8');
            
            // Parse XML properly
            const parser = new xml2js.Parser();
            const result = await parser.parseStringPromise(content);
            
            if (result && result.coverage && result.coverage.project) {
              const project = result.coverage.project[0];
              const metrics = project.metrics ? project.metrics[0].$ : 
                             (project.package ? project.package[0].metrics[0].$ : {});
              
              coverage.method = parseFloat(metrics.methodCoverage) || 0;
              coverage.conditional = parseFloat(metrics.conditionalCoverage) || 0;
              coverage.statement = parseFloat(metrics.statementCoverage) || 0;
              
              coverage.passed = 
                coverage.method >= thresholds.method &&
                coverage.conditional >= thresholds.conditional &&
                coverage.statement >= thresholds.statement;
            }
            
            console.log(`ðŸ“Š Coverage Report:`);
            console.log(`   Method: ${coverage.method}% (target: ${thresholds.method}%)`);
            console.log(`   Conditional: ${coverage.conditional}% (target: ${thresholds.conditional}%)`);
            console.log(`   Statement: ${coverage.statement}% (target: ${thresholds.statement}%)`);
            console.log(`   Overall: ${coverage.passed ? 'âœ… PASSED' : 'âŒ FAILED'}`);
          } else {
            console.log('âš ï¸ Clover report not found');
          }
          
          core.setOutput('method-coverage', coverage.method);
          core.setOutput('conditional-coverage', coverage.conditional);
          core.setOutput('statement-coverage', coverage.statement);
          core.setOutput('coverage-passed', coverage.passed);
    
    - name: Check Coverage Thresholds
      if: steps.clover.outputs.coverage-passed == 'false'
      run: |
        echo "âŒ Coverage thresholds not met!"
        echo "Method coverage: ${{ steps.clover.outputs.method-coverage }}% (required: 70%)"
        echo "Conditional coverage: ${{ steps.clover.outputs.conditional-coverage }}% (required: 80%)" 
        echo "Statement coverage: ${{ steps.clover.outputs.statement-coverage }}% (required: 80%)"
        exit 1
    
    - name: Package Application
      if: success()
      run: |
        echo 'packaging..'
        mvn package
    
    - name: Upload Package
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: webapp-package
        path: target/*.war
    
    - name: Display Build Summary
      if: always()
      run: |
        echo "## ðŸ“‹ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| Compilation | âœ… | Completed |" >> $GITHUB_STEP_SUMMARY
        echo "| PMD Analysis | ${{ steps.pmd.outcome == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ steps.pmd.outcome == 'success' && 'No issues' || 'See artifacts' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Tests with Clover | âœ… | Executed |" >> $GITHUB_STEP_SUMMARY
        echo "| Coverage | ${{ steps.clover.outputs.coverage-passed == 'true' && 'âœ…' || 'âŒ' }} | Methods: ${{ steps.clover.outputs.method-coverage }}%, Conditional: ${{ steps.clover.outputs.conditional-coverage }}%, Statements: ${{ steps.clover.outputs.statement-coverage }}% |" >> $GITHUB_STEP_SUMMARY
        echo "| Package | âœ… | Created |" >> $GITHUB_STEP_SUMMARY
