name: CI Pipeline (Jenkins-like)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggers

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        repository: kpashindla29/spring-to-aws-demo-new-3
        # If it's a private repo, add token
        # token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'  # Eclipse Temurin (Adoptium)
        cache: maven
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: Compile
      run: |
        echo 'compiling..'
        mvn compile
      continue-on-error: false
    
    - name: Code Review (PMD)
      id: pmd
      run: |
        echo 'codereview..'
        mvn -P metrics pmd:pmd
      continue-on-error: true
    
    - name: Publish PMD Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pmd-results
        path: '**/target/pmd.xml'
    
    # PMD analysis in PR comments
    - name: Comment PMD Results on PR
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const files = await glob('**/target/pmd.xml');
          
          if (files.length === 0) {
            console.log('No PMD results found');
            return;
          }
          
          // Parse and format PMD results (simplified)
          let comment = '## PMD Code Review Results\n\n';
          comment += 'PMD analysis completed. Check the artifacts for full results.';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: Run Tests with Clover
      run: |
        echo 'running tests with clover..'
        mvn test clover:aggregate clover:clover
      continue-on-error: false
    
    - name: Upload Clover Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: clover-reports
        path: |
          target/site/clover/**
          target/site/clover.xml
    
    - name: Clover Coverage Report
      id: clover
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Check coverage thresholds (similar to Jenkins plugin)
          const thresholds = {
            method: 70,
            conditional: 80,
            statement: 80
          };
          
          // Try to read clover.xml and parse coverage
          const cloverPath = 'target/site/clover.xml';
          let coverage = {
            method: 0,
            conditional: 0,
            statement: 0,
            passed: false
          };
          
          if (fs.existsSync(cloverPath)) {
            const content = fs.readFileSync(cloverPath, 'utf8');
            // Simple regex to extract coverage - in real world use XML parser
            const methodMatch = content.match(/methodCoverage="([\d.]+)"/);
            const condMatch = content.match(/conditionalCoverage="([\d.]+)"/);
            const stmtMatch = content.match(/statementCoverage="([\d.]+)"/);
            
            coverage.method = methodMatch ? parseFloat(methodMatch[1]) : 0;
            coverage.conditional = condMatch ? parseFloat(condMatch[1]) : 0;
            coverage.statement = stmtMatch ? parseFloat(stmtMatch[1]) : 0;
            
            coverage.passed = 
              coverage.method >= thresholds.method &&
              coverage.conditional >= thresholds.conditional &&
              coverage.statement >= thresholds.statement;
            
            console.log(`Coverage - Method: ${coverage.method}%, Conditional: ${coverage.conditional}%, Statement: ${coverage.statement}%`);
            console.log(`Thresholds - Method: ${thresholds.method}%, Conditional: ${thresholds.conditional}%, Statement: ${thresholds.statement}%`);
            console.log(`Overall: ${coverage.passed ? 'PASSED ✓' : 'FAILED ✗'}`);
          }
          
          // Set outputs
          core.setOutput('method-coverage', coverage.method);
          core.setOutput('conditional-coverage', coverage.conditional);
          core.setOutput('statement-coverage', coverage.statement);
          core.setOutput('coverage-passed', coverage.passed);
    
    - name: Check Coverage Thresholds
      if: steps.clover.outputs.coverage-passed == 'false'
      run: |
        echo "Coverage thresholds not met!"
        echo "Method coverage: ${{ steps.clover.outputs.method-coverage }}% (required: 70%)"
        echo "Conditional coverage: ${{ steps.clover.outputs.conditional-coverage }}% (required: 80%)" 
        echo "Statement coverage: ${{ steps.clover.outputs.statement-coverage }}% (required: 80%)"
        exit 1
    
    - name: Package Application
      if: success()
      run: |
        echo 'packaging..'
        mvn package
    
    - name: Upload Package
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: webapp-package
        path: target/*.war
    
    - name: Display Build Summary
      if: always()
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Compilation: ✅" >> $GITHUB_STEP_SUMMARY
        echo "- PMD Analysis: ${{ steps.pmd.outcome == 'success' && '✅' || '⚠️' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Tests with Clover: ✅" >> $GITHUB_STEP_SUMMARY
        echo "- Coverage: ${{ steps.clover.outputs.method-coverage }}% methods, ${{ steps.clover.outputs.conditional-coverage }}% conditional, ${{ steps.clover.outputs.statement-coverage }}% statements" >> $GITHUB_STEP_SUMMARY
        echo "- Package: ✅" >> $GITHUB_STEP_SUMMARY
